/*! Built with http://stenciljs.com */
const{h:e}=window.webphotofilter;class t{static getFilters(e){return{SEPIA:[1.351,0,0,0,0,1.203,0,0,0,0,.937,0,0,0,0,0,0,0,1,0],BLUE_MONOTONE:[.95,0,0,0,.05,.85,0,0,0,.15,.5,0,0,0,.5,0,0,0,1,0],VIOLENT_TOMATO:[.9,0,0,0,2,.9,0,0,0,-.2,-.2,0,0,0,-.5,-.2,-.2,-.2,1,0],GREYSCALE:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,1,0],BRIGHTNESS:t.brightnessMatrix(e||1.4),SATURATION:t.saturationMatrix(e||1.5),CONTRAST:t.contrastMatrix(e||1.5),HUE:t.hueMatrix(e||90),COOKIE:[.5997023582458496,.3455324172973633,-.27082985639572144,0,.186007559299469,-.0377032496035099,.8609577417373657,.1505955308675766,0,-.14497417211532593,.2411363571882248,-.07441037893295288,.4497218132019043,0,-.029655195772647858,0,0,0,1,0],VINTAGE:[.6279345750808716,.32021835446357727,-.03965408354997635,0,.037848182022571564,.025783976539969444,.6441188454627991,.03259127587080002,0,.02926599606871605,.04660555720329285,-.08512330055236816,.5241647958755493,0,.020232120528817177,0,0,0,1,0],KODA:[1.1285582780838013,-.3967382311820984,-.03992559015750885,0,.24991995096206665,-.1640433967113495,1.0835251808166504,-.05498805269598961,0,.09698984026908875,-.16786010563373566,-.5603416562080383,1.6014851331710815,0,.13972482085227966,0,0,0,1,0],TECHNICOLOR:[1.9125277996063232,-.8545345067977905,-.09155508130788803,0,.046249426901340485,-.3087833523750305,1.7658908367156982,-.10601743310689926,0,-.27589040994644165,-.23110337555408478,-.7501899003982544,1.8475978374481201,0,.12137623876333237,0,0,0,1,0],POLAROID:[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0],BGR:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0]}}static brightnessMatrix(e){return[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0]}static contrastMatrix(e){let r=-128*(e-1);return t.normalizeMatrix([e,0,0,0,r,0,e,0,0,r,0,0,e,0,r,0,0,0,1,0])}static normalizeMatrix(e){return e[4]/=255,e[9]/=255,e[14]/=255,e[19]/=255,e}static hueMatrix(e){e=(e||0)/180*Math.PI;let t=Math.cos(e),r=Math.sin(e);return[.213+.787*t+-.213*r,.715+-.715*t+-.715*r,.072+-.072*t+.928*r,0,0,.213+-.213*t+.143*r,.715+t*(1-.715)+.14*r,.072+-.072*t+-.283*r,0,0,.213+-.213*t+-.787*r,.715+-.715*t+.715*r,.072+.928*t+.072*r,0,0,0,0,0,1,0]}static saturationMatrix(e){let t=2*(e||0)/3+1,r=-.5*(t-1);return[t,r,r,0,0,r,t,r,0,0,r,r,t,0,0,0,0,0,1,0]}static getFilter(e,r){if(!e||0===e.length)return null;let n=null;return Object.keys(t.getFilters(r)).forEach(i=>{e.toUpperCase()===i&&(n=t.getFilters(r)[i])}),n}}class r{constructor(){this.keep=!1,this.vertexShaderSource="\n    attribute vec2 a_position;\n    attribute vec2 a_texCoord;\n    uniform vec2 u_resolution;\n    varying vec2 v_texCoord;\n  \n    void main() {\n       vec2 clipSpace = (a_position / u_resolution) * 2.0 - 1.0; // convert the rectangle from pixels to clipspace\n       gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n       v_texCoord = a_texCoord; // pass the texCoord to the fragment shader\n    }\n  ",this.fragmentShaderSource="\n    precision mediump float;\n    uniform sampler2D u_image; // the texture\n    uniform mat4 u_matrix;\n    uniform vec4 u_multiplier;\n    varying vec2 v_texCoord; // the texCoords passed from the vertex shader.\n  \n    void main() {\n      vec4 color = texture2D(u_image, v_texCoord);\n      mat4 colMat = mat4(\n      color.r, 0, 0, 0,\n      0, color.g, 0, 0,\n      0, 0, color.b, 0,\n      0, 0, 0, color.a\n      );\n      mat4 product = colMat * u_matrix;\n      color.r = product[0].x + product[0].y + product[0].z + product[0].w + u_multiplier[0];\n      color.g = product[1].x + product[1].y + product[1].z + product[1].w + u_multiplier[1];\n      color.b = product[2].x + product[2].y + product[2].z + product[2].w + u_multiplier[2];\n      color.a = product[3].x + product[3].y + product[3].z + product[3].w  + u_multiplier[3];\n      gl_FragColor = color;\n    }\n  "}componentWillLoad(){this.srcImgId="webPhotoFilterImg"+Date.now(),this.canvasId="webPhotoFilterCanvas"+Date.now()}createWebGLProgram(e,t,r){let n=(t,r)=>{let n=e.createShader(r);return e.shaderSource(n,t),e.compileShader(n),n},i=e.createProgram();return e.attachShader(i,n(t,e.VERTEX_SHADER)),e.attachShader(i,n(r,e.FRAGMENT_SHADER)),e.linkProgram(i),e.useProgram(i),i}componentWillUpdate(){this.applyFilter()}applyFilter(){const e=this.el.querySelector("img#"+this.srcImgId);if(null==e)return;let r=t.getFilter(this.filter,this.level);if(null===r)return e.classList.add("display-no-filter"),void this.emitFilterApplied(e,this.hasValidWegGLContext());this.desaturateImage(e,r)}emitFilterApplied(e,t){this.filterLoad.emit({webGLDetected:t,result:e})}createCanvas(e){let t=document.createElement("canvas");return t.id=this.canvasId,t.width=e.naturalWidth,t.height=e.naturalHeight,e.parentNode.insertBefore(t,e),t}desaturateImage(e,t){let r,n=this.el.querySelector("canvas#"+this.canvasId);n||(n=this.createCanvas(e)),this.keep||e.parentNode.removeChild(e);try{r=n.getContext("webgl",{preserveDrawingBuffer:!0})}catch(t){return void this.emitFilterApplied(e,!1)}if(!r)return void this.emitFilterApplied(e,!1);let i=this.createWebGLProgram(r,this.vertexShaderSource,this.fragmentShaderSource),a=r.getUniformLocation(i,"u_resolution");r.uniform2f(a,n.width,n.height);let o=t.slice(),l=[];l.push(o.splice(3,1)[0]),l.push(o.splice(8,1)[0]),l.push(o.splice(12,1)[0]),l.push(o.splice(16,1)[0]);let c=r.getUniformLocation(i,"u_matrix");r.uniformMatrix4fv(c,!1,new Float32Array(o));let s=r.getUniformLocation(i,"u_multiplier");r.uniform4f(s,l[0],l[1],l[2],l[3]);let u=r.getAttribLocation(i,"a_position"),d=r.createBuffer();r.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,d),r.bufferData(WebGLRenderingContext.ARRAY_BUFFER,new Float32Array([0,0,e.naturalWidth,0,0,e.naturalHeight,0,e.naturalHeight,e.naturalWidth,0,e.naturalWidth,e.naturalHeight]),WebGLRenderingContext.STATIC_DRAW),r.enableVertexAttribArray(u),r.vertexAttribPointer(u,2,WebGLRenderingContext.FLOAT,!1,0,0);let p=r.getAttribLocation(i,"a_texCoord"),h=r.createBuffer();r.bindBuffer(WebGLRenderingContext.ARRAY_BUFFER,h),r.bufferData(WebGLRenderingContext.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),WebGLRenderingContext.STATIC_DRAW),r.enableVertexAttribArray(p),r.vertexAttribPointer(p,2,WebGLRenderingContext.FLOAT,!1,0,0);let g=r.createTexture();r.bindTexture(WebGLRenderingContext.TEXTURE_2D,g),r.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_S,WebGLRenderingContext.CLAMP_TO_EDGE),r.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_WRAP_T,WebGLRenderingContext.CLAMP_TO_EDGE),r.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MIN_FILTER,WebGLRenderingContext.NEAREST),r.texParameteri(WebGLRenderingContext.TEXTURE_2D,WebGLRenderingContext.TEXTURE_MAG_FILTER,WebGLRenderingContext.NEAREST),r.texImage2D(WebGLRenderingContext.TEXTURE_2D,0,WebGLRenderingContext.RGBA,WebGLRenderingContext.RGBA,WebGLRenderingContext.UNSIGNED_BYTE,e),r.drawArrays(WebGLRenderingContext.TRIANGLES,0,6),this.emitFilterApplied(n,!0)}hasValidWegGLContext(){let e,t=document.createElement("canvas");try{e=t.getContext("webgl",{preserveDrawingBuffer:!0})}catch(e){return!1}return e&&e instanceof WebGLRenderingContext}render(){return e("img",{id:this.srcImgId,src:this.src,alt:this.alt,onLoad:()=>this.applyFilter()})}static get is(){return"web-photo-filter"}static get properties(){return{alt:{type:String,attr:"alt"},el:{elementRef:!0},filter:{type:String,attr:"filter"},keep:{type:Boolean,attr:"keep"},level:{type:Number,attr:"level"},src:{type:String,attr:"src"}}}static get events(){return[{name:"filterLoad",method:"filterLoad",bubbles:!0,cancelable:!0,composed:!0}]}static get style(){return"web-photo-filter img{display:none}web-photo-filter img.display-no-filter{display:block}"}}export{r as WebPhotoFilter};